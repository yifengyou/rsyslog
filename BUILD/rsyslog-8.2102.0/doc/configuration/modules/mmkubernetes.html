
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Kubernetes Metadata Module (mmkubernetes) &#8212; rsyslog 8.2102.0 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/rsyslog.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Log Message Normalization Module (mmnormalize)" href="mmnormalize.html" />
    <link rel="prev" title="JSON/CEE Structured Content Extraction Module (mmjsonparse)" href="mmjsonparse.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="mmnormalize.html" title="Log Message Normalization Module (mmnormalize)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="mmjsonparse.html" title="JSON/CEE Structured Content Extraction Module (mmjsonparse)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">rsyslog 8.2102.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Configuration</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Modules</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="idx_messagemod.html" accesskey="U">Message Modification Modules</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="kubernetes-metadata-module-mmkubernetes">
<h1>Kubernetes Metadata Module (mmkubernetes)<a class="headerlink" href="#kubernetes-metadata-module-mmkubernetes" title="Permalink to this headline">¶</a></h1>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="74%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>Module Name:</strong></td>
<td><strong>mmkubernetes</strong></td>
</tr>
<tr class="row-even"><td><strong>Author:</strong></td>
<td><cite>Tomáš Heinrich</cite>
<cite>Rich Megginson</cite> &lt;<a class="reference external" href="mailto:rmeggins&#37;&#52;&#48;redhat&#46;com">rmeggins<span>&#64;</span>redhat<span>&#46;</span>com</a>&gt;</td>
</tr>
</tbody>
</table>
<div class="section" id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h2>
<p>This module is used to add <cite>Kubernetes &lt;https://kubernetes.io/&gt;</cite>
metadata to log messages logged by containers running in Kubernetes.
It will add the namespace uuid, pod uuid, pod and namespace labels and
annotations, and other metadata associated with the pod and
namespace.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This <strong>only</strong> works with log files in <cite>/var/log/containers/*.log</cite> (docker
<cite>–log-driver=json-file</cite>, or CRI-O log files), or with journald entries with
message properties <cite>CONTAINER_NAME</cite> and <cite>CONTAINER_ID_FULL</cite> (docker
<cite>–log-driver=journald</cite>), and when the application running inside the
container writes logs to <cite>stdout</cite>/<cite>stderr</cite>.  This <strong>does not</strong> currently
work with other log drivers.</p>
</div>
<p>For json-file and CRI-O logs, you must use the <cite>imfile</cite> module with the
<cite>addmetadata=”on”</cite> parameter, and the filename must match the
liblognorm rules specified by the <cite>filenamerules</cite>
(<a class="reference internal" href="#filenamerules"><span class="std std-ref">filenamerules</span></a>) or <cite>filenamerulebase</cite> (<a class="reference internal" href="#filenamerulebase"><span class="std std-ref">filenamerulebase</span></a>)
parameter values.</p>
<p>For journald logs, there must be a message property <cite>CONTAINER_NAME</cite>
which matches the liblognorm rules specified by the <cite>containerrules</cite>
(<a class="reference internal" href="#containerrules"><span class="std std-ref">containerrules</span></a>) or <cite>containerrulebase</cite>
(<a class="reference internal" href="#containerrulebase"><span class="std std-ref">containerrulebase</span></a>) parameter values. The record must also have
the message property <cite>CONTAINER_ID_FULL</cite>.</p>
<p>This module is implemented via the output module interface. This means
that mmkubernetes should be called just like an action. After it has
been called, there will be two new message properties: <cite>kubernetes</cite>
and <cite>docker</cite>.  There will be subfields of each one for the various
metadata items: <cite>$!kubernetes!namespace_name</cite>
<cite>$!kubernetes!labels!this-is-my-label</cite>, etc.  There is currently only
1 docker subfield: <cite>$!docker!container_id</cite>.  See
<a class="reference external" href="https://github.com/ViaQ/elasticsearch-templates/blob/master/namespaces/kubernetes.yml">https://github.com/ViaQ/elasticsearch-templates/blob/master/namespaces/kubernetes.yml</a>
and
<a class="reference external" href="https://github.com/ViaQ/elasticsearch-templates/blob/master/namespaces/docker.yml">https://github.com/ViaQ/elasticsearch-templates/blob/master/namespaces/docker.yml</a>
for more details.</p>
</div>
<div class="section" id="configuration-parameters">
<h2>Configuration Parameters<a class="headerlink" href="#configuration-parameters" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Parameter names are case-insensitive.</p>
</div>
<div class="section" id="module-parameters-and-action-parameters">
<h3>Module Parameters and Action Parameters<a class="headerlink" href="#module-parameters-and-action-parameters" title="Permalink to this headline">¶</a></h3>
<div class="section" id="kubernetesurl">
<span id="id1"></span><h4>KubernetesURL<a class="headerlink" href="#kubernetesurl" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td><a class="reference external" href="https://kubernetes.default.svc.cluster.local:443">https://kubernetes.default.svc.cluster.local:443</a></td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>The URL of the Kubernetes API server.  Example: <cite>https://localhost:8443</cite>.</p>
</div>
<div class="section" id="tls-cacert">
<span id="mmkubernetes-tls-cacert"></span><h4>tls.cacert<a class="headerlink" href="#tls-cacert" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td>none</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>Full path and file name of file containing the CA cert of the
Kubernetes API server cert issuer.  Example: <cite>/etc/rsyslog.d/mmk8s-ca.crt</cite>.
This parameter is not mandatory if using an <cite>http</cite> scheme instead of <cite>https</cite> in
<cite>kubernetesurl</cite>, or if using <cite>allowunsignedcerts=”yes”</cite>.</p>
</div>
<div class="section" id="tls-mycert">
<span id="mmkubernetes-tls-mycert"></span><h4>tls.mycert<a class="headerlink" href="#tls-mycert" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td>none</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>This is the full path and file name of the file containing the client cert for
doing client cert auth against Kubernetes.  This file is in PEM format.  For
example: <cite>/etc/rsyslog.d/k8s-client-cert.pem</cite></p>
</div>
<div class="section" id="tls-myprivkey">
<span id="mmkubernetes-tls-myprivkey"></span><h4>tls.myprivkey<a class="headerlink" href="#tls-myprivkey" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td>none</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>This is the full path and file name of the file containing the private key
corresponding to the cert <cite>tls.mycert</cite> used for doing client cert auth against
Kubernetes.  This file is in PEM format, and must be unencrypted, so take
care to secure it properly.  For example: <cite>/etc/rsyslog.d/k8s-client-key.pem</cite></p>
</div>
<div class="section" id="tokenfile">
<span id="id2"></span><h4>tokenfile<a class="headerlink" href="#tokenfile" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td>none</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>The file containing the token to use to authenticate to the Kubernetes API
server.  One of <cite>tokenfile</cite> or <cite>token</cite> is required if Kubernetes is configured
with access control.  Example: <cite>/etc/rsyslog.d/mmk8s.token</cite></p>
</div>
<div class="section" id="token">
<span id="id3"></span><h4>token<a class="headerlink" href="#token" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td>none</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>The token to use to authenticate to the Kubernetes API server.  One of <cite>token</cite>
or <cite>tokenfile</cite> is required if Kubernetes is configured with access control.
Example: <cite>UxMU46ptoEWOSqLNa1bFmH</cite></p>
</div>
<div class="section" id="annotation-match">
<span id="id4"></span><h4>annotation_match<a class="headerlink" href="#annotation-match" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>array</td>
<td>none</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>By default no pod or namespace annotations will be added to the
messages.  This parameter is an array of patterns to match the keys of
the <cite>annotations</cite> field in the pod and namespace metadata to include
in the <cite>$!kubernetes!annotations</cite> (for pod annotations) or the
<cite>$!kubernetes!namespace_annotations</cite> (for namespace annotations)
message properties.  Example: <cite>[“k8s.*master”,”k8s.*node”]</cite></p>
</div>
<div class="section" id="srcmetadatapath">
<span id="id5"></span><h4>srcmetadatapath<a class="headerlink" href="#srcmetadatapath" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td>$!metadata!filename</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>When reading json-file logs, with <cite>imfile</cite> and <cite>addmetadata=”on”</cite>,
this is the property where the filename is stored.</p>
</div>
<div class="section" id="dstmetadatapath">
<span id="id6"></span><h4>dstmetadatapath<a class="headerlink" href="#dstmetadatapath" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td>$!</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>This is the where the <cite>kubernetes</cite> and <cite>docker</cite> properties will be
written.  By default, the module will add <cite>$!kubernetes</cite> and
<cite>$!docker</cite>.</p>
</div>
<div class="section" id="allowunsignedcerts">
<span id="id7"></span><h4>allowunsignedcerts<a class="headerlink" href="#allowunsignedcerts" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>boolean</td>
<td>off</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>If <cite>“on”</cite>, this will set the curl <cite>CURLOPT_SSL_VERIFYPEER</cite> option to
<cite>0</cite>.  You are strongly discouraged to set this to <cite>“on”</cite>.  It is
primarily useful only for debugging or testing.</p>
</div>
<div class="section" id="skipverifyhost">
<span id="id8"></span><h4>skipverifyhost<a class="headerlink" href="#skipverifyhost" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>boolean</td>
<td>off</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>If <cite>“on”</cite>, this will set the curl <cite>CURLOPT_SSL_VERIFYHOST</cite> option to
<cite>0</cite>.  You are strongly discouraged to set this to <cite>“on”</cite>.  It is
primarily useful only for debugging or testing.</p>
</div>
<div class="section" id="de-dot">
<span id="id9"></span><h4>de_dot<a class="headerlink" href="#de-dot" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>boolean</td>
<td>on</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>When processing labels and annotations, if this parameter is set to
<cite>“on”</cite>, the key strings will have their <cite>.</cite> characters replaced with
the string specified by the <cite>de_dot_separator</cite> parameter.</p>
</div>
<div class="section" id="de-dot-separator">
<span id="id10"></span><h4>de_dot_separator<a class="headerlink" href="#de-dot-separator" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td>_</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>When processing labels and annotations, if the <cite>de_dot</cite> parameter is
set to <cite>“on”</cite>, the key strings will have their <cite>.</cite> characters replaced
with the string specified by the string value of this parameter.</p>
</div>
<div class="section" id="filenamerules">
<span id="id11"></span><h4>filenamerules<a class="headerlink" href="#filenamerules" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td>SEE BELOW</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This directive is not supported with liblognorm 2.0.2 and earlier.</p>
</div>
<p>When processing json-file logs, these are the lognorm rules to use to
match the filename and extract metadata.  The default value is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span><span class="o">=</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">containers</span><span class="o">/%</span><span class="n">pod_name</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="n">_</span><span class="o">%</span><span class="n">_</span><span class="o">%</span><span class="n">namespace_name</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="n">_</span><span class="o">%</span><span class="n">_</span><span class="o">%</span><span class="n">contai</span>\
<span class="n">ner_name_and_id</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="o">.%.</span><span class="n">log</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the above rules, the slashes <code class="docutils literal notranslate"><span class="pre">\</span></code> ending each line indicate
line wrapping - they are not part of the rule.</p>
</div>
</div>
<div class="section" id="filenamerulebase">
<span id="id12"></span><h4>filenamerulebase<a class="headerlink" href="#filenamerulebase" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td>/etc/rsyslog.d/k8s_filename.rulebase</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>When processing json-file logs, this is the rulebase used to match the filename
and extract metadata.  For the actual rules, see <a class="reference internal" href="#filenamerules"><span class="std std-ref">filenamerules</span></a>.</p>
</div>
<div class="section" id="containerrules">
<span id="id13"></span><h4>containerrules<a class="headerlink" href="#containerrules" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td>SEE BELOW</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This directive is not supported with liblognorm 2.0.2 and earlier.</p>
</div>
<p>For journald logs, there must be a message property <cite>CONTAINER_NAME</cite>
which has a value matching these rules specified by this parameter.
The default value is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span><span class="o">=</span><span class="p">:</span><span class="o">%</span><span class="n">k8s_prefix</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="n">_</span><span class="o">%</span><span class="n">_</span><span class="o">%</span><span class="n">container_name</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="o">.%.%</span><span class="n">container_hash</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span>\
<span class="n">_</span><span class="o">%</span><span class="n">_</span><span class="o">%</span><span class="n">pod_name</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="n">_</span><span class="o">%</span><span class="n">_</span><span class="o">%</span><span class="n">namespace_name</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="n">_</span><span class="o">%</span><span class="n">_</span><span class="o">%</span><span class="n">not_used_1</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="n">_</span><span class="o">%</span><span class="n">_</span><span class="o">%</span><span class="n">not_u</span>\
<span class="n">sed_2</span><span class="p">:</span><span class="n">rest</span><span class="o">%</span>
<span class="n">rule</span><span class="o">=</span><span class="p">:</span><span class="o">%</span><span class="n">k8s_prefix</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="n">_</span><span class="o">%</span><span class="n">_</span><span class="o">%</span><span class="n">container_name</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="n">_</span><span class="o">%</span><span class="n">_</span><span class="o">%</span><span class="n">pod_name</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="n">_</span><span class="o">%</span><span class="n">_</span><span class="o">%</span><span class="n">na</span>\
<span class="n">mespace_name</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="n">_</span><span class="o">%</span><span class="n">_</span><span class="o">%</span><span class="n">not_used_1</span><span class="p">:</span><span class="n">char</span><span class="o">-</span><span class="n">to</span><span class="p">:</span><span class="n">_</span><span class="o">%</span><span class="n">_</span><span class="o">%</span><span class="n">not_used_2</span><span class="p">:</span><span class="n">rest</span><span class="o">%</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the above rules, the slashes <code class="docutils literal notranslate"><span class="pre">\</span></code> ending each line indicate
line wrapping - they are not part of the rule.</p>
</div>
<p>There are two rules because the <cite>container_hash</cite> is optional.</p>
</div>
<div class="section" id="containerrulebase">
<span id="id14"></span><h4>containerrulebase<a class="headerlink" href="#containerrulebase" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>word</td>
<td>/etc/rsyslog.d/k8s_container_name.rulebase</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>When processing json-file logs, this is the rulebase used to match the
CONTAINER_NAME property value and extract metadata.  For the actual rules, see
<a class="reference internal" href="#containerrules"><span class="std std-ref">containerrules</span></a>.</p>
</div>
<div class="section" id="busyretryinterval">
<span id="mmkubernetes-busyretryinterval"></span><h4>busyretryinterval<a class="headerlink" href="#busyretryinterval" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>integer</td>
<td>5</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>The number of seconds to wait before retrying operations to the Kubernetes API
server after receiving a <cite>429 Busy</cite> response.  The default <cite>“5”</cite> means that the
module will retry the connection every <cite>5</cite> seconds.  Records processed during
this time will _not_ have any additional metadata associated with them, so you
will need to handle cases where some of your records have all of the metadata
and some do not.</p>
<p>If you want to have rsyslog suspend the plugin until the Kubernetes API server
is available, set <cite>busyretryinterval</cite> to <cite>“0”</cite>.  This will cause the plugin to
return an error to rsyslog.</p>
</div>
<div class="section" id="sslpartialchain">
<span id="mmkubernetes-sslpartialchain"></span><h4>sslpartialchain<a class="headerlink" href="#sslpartialchain" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>boolean</td>
<td>off</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>This option is only available if rsyslog was built with support for OpenSSL and
only if the <cite>X509_V_FLAG_PARTIAL_CHAIN</cite> flag is available.  If you attempt to
set this parameter on other platforms, you will get an <cite>INFO</cite> level log
message.  This was done so that you could use the same configuration on
different platforms.
If <cite>“on”</cite>, this will set the OpenSSL certificate store flag
<cite>X509_V_FLAG_PARTIAL_CHAIN</cite>.   This will allow you to verify the Kubernetes API
server cert with only an intermediate CA cert in your local trust store, rather
than having to have the entire intermediate CA + root CA chain in your local
trust store.  See also <cite>man s_client</cite> - the <cite>-partial_chain</cite> flag.
If you get errors like this, you probably need to set <cite>sslpartialchain=”on”</cite>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>rsyslogd: mmkubernetes: failed to connect to [https://...url...] -
60:Peer certificate cannot be authenticated with given CA certificates
</pre></div>
</div>
</div>
<div class="section" id="cacheexpireinterval">
<span id="mmkubernetes-cacheexpireinterval"></span><h4>cacheexpireinterval<a class="headerlink" href="#cacheexpireinterval" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>integer</td>
<td>-1</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>This parameter allows you to expire entries from the metadata cache.  The
values are:</p>
<ul class="simple">
<li>-1 (default) - disables metadata cache expiration</li>
<li>0 - check cache for expired entries before every cache lookup</li>
<li>1 or higher - the number is a number of seconds - check the cache
for expired entries every this many seconds, when processing an
entry</li>
</ul>
<p>The cache is only checked if processing a record from Kubernetes.  There
isn’t some sort of housekeeping thread that continually runs cleaning up
the cache.  When an record from Kubernetes is processed:</p>
<p>If <cite>cacheexpireinterval</cite> is -1, then do not check for cache expiration.
If <cite>cacheexpireinterval</cite> is 0, then check for cache expiration.
If <cite>cacheexpireinterval</cite> is greater than 0, check for cache expiration
if the last time we checked was more than this many seconds ago.</p>
<p>When cache expiration is checked, it will delete all cache entries which
have a ttl less than or equal to the current time.  The cache entry ttl
is set using the <cite>cacheentryttl</cite>.</p>
</div>
<div class="section" id="cacheentryttl">
<span id="mmkubernetes-cacheentryttl"></span><h4>cacheentryttl<a class="headerlink" href="#cacheentryttl" title="Permalink to this headline">¶</a></h4>
<table border="1" class="colwidths-auto parameter-table docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">type</th>
<th class="head">default</th>
<th class="head">mandatory</th>
<th class="head"><code class="docutils literal notranslate"><span class="pre">obsolete</span> <span class="pre">legacy</span></code> directive</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>integer</td>
<td>3600</td>
<td>no</td>
<td>none</td>
</tr>
</tbody>
</table>
<p>This parameter allows you to set the maximum age (time-to-live, or ttl) of
an entry in the metadata cache.  The value is in seconds.  The default value
is <cite>3600</cite> (one hour).  When cache expiration is checked, if a cache entry
has a ttl less than or equal to the current time, it will be removed from
the cache.</p>
<p>This option is only used if <cite>cacheexpireinterval</cite> is 0 or greater.</p>
<p>This value must be 0 or greater, otherwise, if <cite>cacheexpireinterval</cite> is 0
or greater, you will get an error.</p>
</div>
</div>
</div>
<div class="section" id="statistic-counter">
<span id="mmkubernetes-statistic-counter"></span><h2>Statistic Counter<a class="headerlink" href="#statistic-counter" title="Permalink to this headline">¶</a></h2>
<p>This plugin maintains per-action <a class="reference internal" href="../rsyslog_statistic_counter.html"><span class="doc">statistics</span></a>.  The statistic is named
“mmkubernetes($kubernetesurl)”, where <cite>$kubernetesurl</cite> is the
<a class="reference internal" href="#kubernetesurl"><span class="std std-ref">KubernetesURL</span></a> setting for the action.</p>
<p>Parameters are:</p>
<ul class="simple">
<li><strong>recordseen</strong> - number of messages seen by the action which the action has
determined have Kubernetes metadata associated with them</li>
<li><strong>namespacemetadatasuccess</strong> - the number of times a successful request was
made to the Kubernetes API server for namespace metadata.</li>
<li><strong>namespacemetadatanotfound</strong> - the number of times a request to the
Kubernetes API server for namespace metadata was returned with a <cite>404 Not
Found</cite> error code - the namespace did not exist at that time.</li>
<li><strong>namespacemetadatabusy</strong> - the number of times a request to the Kubernetes
API server for namespace metadata was returned with a <cite>429 Busy</cite> error
code - the server was too busy to send a proper response.</li>
<li><strong>namespacemetadataerror</strong> - the number of times a request to the Kubernetes
API server for namespace metadata was returned with some other error code
not handled above.  These are typically “hard” errors which require some
sort of intervention to fix e.g. Kubernetes server down, credentials incorrect.</li>
<li><strong>podmetadatasuccess</strong> - the number of times a successful request was made
to the Kubernetes API server for pod metadata.</li>
<li><strong>podmetadatanotfound</strong> - the number of times a request to the Kubernetes
API server for pod metadata was returned with a <cite>404 Not Found</cite> error code -
the pod did not exist at that time.</li>
<li><strong>podmetadatabusy</strong> - the number of times a request to the Kubernetes API
server for pod metadata was returned with a <cite>429 Busy</cite> error code - the
server was too busy to send a proper response.</li>
<li><strong>podmetadataerror</strong> - the number of times a request to the Kubernetes API
server for pod metadata was returned with some other error code not handled
above.  These are typically “hard” errors which require some sort of
intervention to fix e.g. Kubernetes server down, credentials incorrect.</li>
<li><strong>podcachenumentries</strong> - the number of entries in the pod metadata cache.</li>
<li><strong>namespacecachenumentries</strong> - the number of entries in the namespace metadata
cache.</li>
<li><strong>podcachehits</strong> - the number of times a requested entry was found in the
pod metadata cache.</li>
<li><strong>namespacecachehits</strong> - the number of times a requested entry was found in the
namespace metadata cache.</li>
<li><strong>podcachemisses</strong> - the number of times a requested entry was not found in the
pod metadata cache, and had to be requested from Kubernetes.</li>
<li><strong>namespacecachemisses</strong> - the number of times a requested entry was not found
in the namespace metadata cache, and had to be requested from Kubernetes.</li>
</ul>
<div class="section" id="fields">
<h3>Fields<a class="headerlink" href="#fields" title="Permalink to this headline">¶</a></h3>
<p>These are the fields added from the metadata in the json-file filename, or from
the <cite>CONTAINER_NAME</cite> and <cite>CONTAINER_ID_FULL</cite> fields from the <cite>imjournal</cite> input:</p>
<p><cite>$!kubernetes!namespace_name</cite>, <cite>$!kubernetes!pod_name</cite>,
<cite>$!kubernetes!container_name</cite>, <cite>$!docker!id</cite>, <cite>$!kubernetes!master_url</cite>.</p>
<p>If mmkubernetes can extract the above fields from the input, the following
fields will always be present.  If they are not present, mmkubernetes
failed to look up the namespace or pod in Kubernetes:</p>
<p><cite>$!kubernetes!namespace_id</cite>, <cite>$!kubernetes!pod_id</cite>,
<cite>$!kubernetes!creation_timestamp</cite>, <cite>$!kubernetes!host</cite></p>
<p>The following fields may be present, depending on how the namespace and pod are
defined in Kubernetes, and depending on the value of the directive
<cite>annotation_match</cite>:</p>
<p><cite>$!kubernetes!labels</cite>, <cite>$!kubernetes!annotations</cite>, <cite>$!kubernetes!namespace_labels</cite>,
<cite>$!kubernetes!namespace_annotations</cite></p>
<p>More fields may be added in the future.</p>
</div>
<div class="section" id="error-handling">
<h3>Error Handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h3>
<p>If the plugin encounters a <cite>404 Not Found</cite> in response to a request for
namespace or pod metadata, that is, the pod or namespace is missing, the plugin
will cache that result, and no metadata will be available for that pod or
namespace forever.  If the pod or namespace is recreated, you will need to
restart rsyslog in order to clear the cache and allow it to find that metadata.</p>
<p>If the plugin gets a <cite>429 Busy</cite> response, the plugin will _not_ cache that
result, and will _not_ add the metadata to the record. This can happen in very
large Kubernetes clusters when you run into the upper limit on the number of
concurrent Kubernetes API service connections.  You may have to increase that
limit.  In the meantime, you can control what the plugin does with those
records using the <a class="reference internal" href="#mmkubernetes-busyretryinterval"><span class="std std-ref">busyretryinterval</span></a> setting.  If you want
to continue to process the records, but with incomplete metadata, set
<cite>busyretryinterval</cite> to a non-zero value, which will be the number of seconds
after which mmkubernetes will retry the connection.  The default value is <cite>5</cite>,
so by default, the plugin will retry the connection every <cite>5</cite> seconds.  If the
<cite>429</cite> error condition in the Kubernetes API server is brief and transient, this
means you will have some (hopefully small) number of records without the
metadata such as the uuids, labels, and annotations, but your pipeline will not
stop.  If the <cite>429</cite> error condition in the Kubernetes API server is persistent,
it may require Kubernetes API server administrator intervention to address, and
you may want to use the <cite>busyretryinterval</cite> value of <cite>“0”</cite>.  This will cause
the module to return a “hard” error (see below).</p>
<p>For other errors, the plugin will assume they are “hard” errors requiring admin
intervention, return an error code, and rsyslog will suspend the plugin.  Use
the <a class="reference internal" href="#mmkubernetes-statistic-counter"><span class="std std-ref">Statistic Counter</span></a> to monitor for problems getting data
from the Kubernetes API service.</p>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>Assuming you have an <cite>imfile</cite> input reading from docker json-file container
logs managed by Kubernetes, with <cite>addmetadata=”on”</cite> so that mmkubernetes can
get the basic necessary Kubernetes metadata from the filename:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input(type=&quot;imfile&quot; file=&quot;/var/log/containers/*.log&quot;
      tag=&quot;kubernetes&quot; addmetadata=&quot;on&quot;)
</pre></div>
</div>
<p>(Add <cite>reopenOnTruncate=”on”</cite> if using Docker, not required by CRI-O).</p>
<p>and/or an <cite>imjournal</cite> input for docker journald container logs annotated by
Kubernetes:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>input(type=&quot;imjournal&quot;)
</pre></div>
</div>
<p>Then mmkubernetes can be used to annotate log records like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>module(load=&quot;mmkubernetes&quot;)

action(type=&quot;mmkubernetes&quot;)
</pre></div>
</div>
<p>After this, you should have log records with fields described in the <cite>Fields</cite>
section above.</p>
</div>
<div class="section" id="credits">
<h3>Credits<a class="headerlink" href="#credits" title="Permalink to this headline">¶</a></h3>
<p>This work is based on
<a class="reference external" href="https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter">https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter</a>
and has many of the same features.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p>Help with configuring/using <code class="docutils literal notranslate"><span class="pre">Rsyslog</span></code>:</p>
<ul class="last simple">
<li><a class="reference external" href="http://lists.adiscon.net/mailman/listinfo/rsyslog">Mailing list</a> - best route for general questions</li>
<li>GitHub: <a class="reference external" href="https://github.com/rsyslog/rsyslog/">rsyslog source project</a> - detailed questions, reporting issues
that are believed to be bugs with <code class="docutils literal notranslate"><span class="pre">Rsyslog</span></code></li>
<li>Stack Exchange (<a class="reference external" href="https://stackexchange.com/filters/327462/rsyslog">View</a>, <a class="reference external" href="https://serverfault.com/questions/ask?tags=rsyslog">Ask</a>)
- experimental support from rsyslog community</li>
</ul>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p>Contributing to <code class="docutils literal notranslate"><span class="pre">Rsyslog</span></code>:</p>
<ul class="last simple">
<li>Source project: <a class="reference external" href="https://github.com/rsyslog/rsyslog/blob/master/README.md">rsyslog project README</a>.</li>
<li>Documentation: <a class="reference external" href="https://github.com/rsyslog/rsyslog-doc/blob/master/README.md">rsyslog-doc project README</a></li>
</ul>
</div>
<p>Copyright 2008-2020 <a class="reference external" href="https://rainer.gerhards.net/">Rainer Gerhards</a>
(<a class="reference external" href="https://www.rainer-gerhards.de/grossrinderfeld/">Großrinderfeld</a>),
and Others.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Kubernetes Metadata Module (mmkubernetes)</a><ul>
<li><a class="reference internal" href="#purpose">Purpose</a></li>
<li><a class="reference internal" href="#configuration-parameters">Configuration Parameters</a><ul>
<li><a class="reference internal" href="#module-parameters-and-action-parameters">Module Parameters and Action Parameters</a><ul>
<li><a class="reference internal" href="#kubernetesurl">KubernetesURL</a></li>
<li><a class="reference internal" href="#tls-cacert">tls.cacert</a></li>
<li><a class="reference internal" href="#tls-mycert">tls.mycert</a></li>
<li><a class="reference internal" href="#tls-myprivkey">tls.myprivkey</a></li>
<li><a class="reference internal" href="#tokenfile">tokenfile</a></li>
<li><a class="reference internal" href="#token">token</a></li>
<li><a class="reference internal" href="#annotation-match">annotation_match</a></li>
<li><a class="reference internal" href="#srcmetadatapath">srcmetadatapath</a></li>
<li><a class="reference internal" href="#dstmetadatapath">dstmetadatapath</a></li>
<li><a class="reference internal" href="#allowunsignedcerts">allowunsignedcerts</a></li>
<li><a class="reference internal" href="#skipverifyhost">skipverifyhost</a></li>
<li><a class="reference internal" href="#de-dot">de_dot</a></li>
<li><a class="reference internal" href="#de-dot-separator">de_dot_separator</a></li>
<li><a class="reference internal" href="#filenamerules">filenamerules</a></li>
<li><a class="reference internal" href="#filenamerulebase">filenamerulebase</a></li>
<li><a class="reference internal" href="#containerrules">containerrules</a></li>
<li><a class="reference internal" href="#containerrulebase">containerrulebase</a></li>
<li><a class="reference internal" href="#busyretryinterval">busyretryinterval</a></li>
<li><a class="reference internal" href="#sslpartialchain">sslpartialchain</a></li>
<li><a class="reference internal" href="#cacheexpireinterval">cacheexpireinterval</a></li>
<li><a class="reference internal" href="#cacheentryttl">cacheentryttl</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#statistic-counter">Statistic Counter</a><ul>
<li><a class="reference internal" href="#fields">Fields</a></li>
<li><a class="reference internal" href="#error-handling">Error Handling</a></li>
<li><a class="reference internal" href="#example">Example</a></li>
<li><a class="reference internal" href="#credits">Credits</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="mmjsonparse.html"
                        title="previous chapter">JSON/CEE Structured Content Extraction Module (mmjsonparse)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="mmnormalize.html"
                        title="next chapter">Log Message Normalization Module (mmnormalize)</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/configuration/modules/mmkubernetes.rst.txt"
           rel="nofollow">Show Source</a></li>
    <li><a href="https://github.com/rsyslog/rsyslog-doc/edit/master/source/configuration/modules/mmkubernetes.rst"
           rel="nofollow">Edit on GitHub</a></li>
  </ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="mmnormalize.html" title="Log Message Normalization Module (mmnormalize)"
             >next</a> |</li>
        <li class="right" >
          <a href="mmjsonparse.html" title="JSON/CEE Structured Content Extraction Module (mmjsonparse)"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">rsyslog 8.2102.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Configuration</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Modules</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="idx_messagemod.html" >Message Modification Modules</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>